#! /usr/bin/perl -w

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use MakeExt2Image;
use AddFiles;
use Conv2Image;
use CompressImage;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${DataPath}demo";
$tmpdir = "${BasePath}tmp/demo";
$image = "${ImagePath}demo";
# $tmpinitrd = "${BasePath}tmp/initrd";

# leave that much space
$extra_size = 6000;              # kbyte
$extra_inodes = 4000;

# just make them large enough
$start_size = 10000;             # kbyte
$start_inodes = 16000;

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$debug = exists($ENV{debug}) ? $ENV{debug} : "";
$livecd = exists($ENV{livecd}) ? $ENV{livecd} : "";
$livecd = "" if $livecd && (!-d($livecd) || !-f("$livecd/etc/liveeval-id"));

if($livecd) {
  $start_inodes = 16000;
  $extra_inodes = 3000;
}

# clean up
if(-d($tmpdir)) {
  SUSystem "rm -rf $tmpdir" and die "$Script: failed to remove old $tmpdir";
}

AddFiles $tmpdir, "${srcdir}/demo.file_list", $srcdir or
  die "$Script: failed to setup live-cd image";

# strip everything
SUSystem "fix_perms $tmpdir";
SUSystem "strip_dir $tmpdir";

if($debug =~ /\bignore\b/ || $debug =~ /\bignorelibs\b/) {
  SUSystem "check_libs $tmpdir" and
    warn "$Script: error in shared lib config, please fix\n";
}
else {
  SUSystem "check_libs $tmpdir" and
    die "$Script: error in shared lib config, please fix\n";
}

SUSystem "bin/file_list $tmpdir";
die "failed to make file list" unless -s "$tmpdir/etc/.SuSEfiles";

if($livecd) {
  print "creating links to live cd\n";

  SUSystem "mount --bind $livecd $tmpdir/S.u.S.E." and
    die "failed to mount \"$livecd\"\n";

  SUSystem "chroot $tmpdir /sbin/init --link-livecd" and
    die "failed integrate livecd\n";

  SUSystem "umount $tmpdir/S.u.S.E." and
    die "failed to umount \"$livecd\"\n";
}

Conv2Image $image, $tmpdir, 'ext2', $start_size, $start_inodes, $extra_size, $extra_inodes;
$i = CompressImage $image;
print "$Script: compressed live cd to \"$image\" ($i bytes)\n";

