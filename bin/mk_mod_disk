#! /usr/bin/perl -w

# Create a module disk.
#
# Usage:        mk_mod_disk

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use AddFiles;
use MakeFATImage;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${ImagePath}";
$image = "${ImagePath}modules$ENV{modules}";
$gen = "${DataPath}initrd/gen/module.";
$mdisk_i = "${BasePath}tmp/module_disks_images";
$mdisk_l = "${BasePath}tmp/module_disks_list";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$disk = 1;
$disk = $ENV{modules} + 0 if exists $ENV{modules};

open F, $mdisk_i;
while(<F>) { @modimages_i = split ' ', $1 if /^$disk:\s*(.+?)\s*$/ }
close F;

open F, $mdisk_l;
while(<F>) { @modimages_l = split ' ', $1 if /^$disk:\s*(.+?)\s*$/ }
close F;

($i1, $i2) = split /\./, $ConfigData{suse_release};      

if($ConfigData{product_name} eq "UnitedLinux") {
  $label = "UNITEDLINUX";
}
else {
  $label = "SUSE${i1}${i2}_MODS";
}

# create an empty image
($blocks, $block_size) = MakeFATImage(
  $image, $label, 1,
  undef, undef, undef, undef, undef,
  "\r\nI'm $ConfigData{product_name} module disk $disk. I cannot boot. :-(\r\n"
);

die "$Script: failed to create DOS disk image \"$image\"\n" unless defined $blocks;

printf "$Script: image \"%s\", %u blocks a %u bytes (%u total)\n", $image, $blocks, $block_size, $blocks * $block_size;

# umount it first, just in case
SUSystem "umount /mnt 2>/dev/null";

# add the other files
SUSystem "mount -oloop -t vfat $image /mnt" and
  die "$Script: mount failed";

SUSystem "cp ${DataPath}initrd/module.help /mnt/module.config";
unlink "$image.txt";
for (@modimages_i) {
  SUSystem "cp  $srcdir/$_ /mnt" and die "$Script: could not add $_";
}

for (@modimages_l) {
  SUSystem "sh -c 'cat ${gen}config.$_ >>/mnt/module.config'";
  system "sh -c 'cat ${gen}list.$_ >>$image.txt'";
}

$i3 = $i2*10;
SUSystem "touch -d $i1:$i3 /mnt/*";

print "contents of $image:\n";
system "ls -lU /mnt";

SUSystem "umount /mnt" and
  die "$Script: umount failed";

Print2File $MToolsCfg, "drive r: file=\"$image\"\n" or die "$Script: oops!";
@f = `mdir r:`;
unlink $MToolsCfg;

for (@f) {
  if(/^\s*([ 0-9]+?)\s+bytes\s+free\s*$/) {
    $free = $1;
    $free =~ s/\s+//g;
    last;
  }
}

die "$Script: oops, no space on modules disk???" unless defined $free;

print "$Script: prepared modules disk \"$image\"; $free bytes free\n";

