#! /usr/bin/perl -w

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# the usual fuss...

BEGIN { unshift @INC, ( $0 =~ /(.*?)((?<![^\/])bin\/)?[^\/]+$/ )[0] . "lib" }
use ReadConfig;
use MakeExt2Image;
use AddFiles;
use Conv2Image;

die "usage: $Script\n" if @ARGV;


# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# some config data

$srcdir = "${DataPath}base";
$tmpdir = "${BasePath}tmp/base";

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# now we really start...

$debug = exists($ENV{'debug'}) ?  $ENV{'debug'} : "";

# clean up
if(-d($tmpdir)) {
  SUSystem "rm -rf $tmpdir" and die "$Script: failed to remove old $tmpdir";
}

$ENV{silent} = 1;

system "splashlist" and die "$Script: splash info broken\n";

AddFiles $tmpdir, "${srcdir}/base.file_list", $srcdir or
  die "$Script: failed to setup base system";

SUSystem "fix_perms $tmpdir";

SUSystem "ldconfig -r $tmpdir";
die "$Script: failed to run ldconfig" unless -f "$tmpdir/etc/ld.so.cache";

if($debug =~ /\bignore\b/ || $debug =~ /\bignorelibs\b/) {
  system "check_libs $tmpdir" and
    warn "$Script: error in shared lib config, please fix\n";
}
else {
  system "check_libs $tmpdir" and
    die "$Script: error in shared lib config, please fix\n";
}

print "creating devices...\n";
$rpmarch = $ENV{RPM_ARCH} ? $ENV{RPM_ARCH} : "";
SUSystem "sh -c 'cd $tmpdir/initrddevs; RPM_ARCH=$rpmarch ../makedevs.floppy >/dev/null'" and
  die "$Script: could not create all devices";

system "demolocale" and die "$Script: base system broken\n";

system "mlist1" and die "$Script: base system broken\n";

if($debug =~ /\bignore\b/) {
  system "mlist2" and
    warn "$Script: error in module config, please fix\n";
}
else {
  system "mlist2" and
    die "$Script: error in module config, please fix\n";
}

print "$Script: base system ready\n";

